<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project | 사비</title>
    <link rel="icon" type="image/svg+xml" href="../logo_dark.svg">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="../darkmode.css">
    <script src="https://unpkg.com/lenis@1.1.9/dist/lenis.min.js"></script>
</head>
<body>
    
    <header>
        <div class="header-inner">
            <div class="logo reveal">
                <a href="../">
                    <img src="../logo_dark.svg" alt="sabi logo">
                </a>
            </div>
            <nav class="reveal delay-100">
                <ul>
                    <li><a href="../" style="opacity: 1; font-weight: 700;">Work</a></li>
                    <li><a href="../about/">About</a></li>
                    <li><a href="../contact/">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main id="project-detail-container" class="detail-page">
        <!-- Project content will be dynamically inserted here -->
        <p style="text-align: center; padding: 100px 0;"></p>
    </main>

    <footer id="footer" class="reveal">
        <div class="footer-left">
            <p>박사비 (Sabi Park) — 2026</p>
        </div>
        <div class="footer-right">
            <a href="mailto:contact@sabi.kr">contact@sabi.kr</a>
            <a href="https://www.instagram.com/sabscr/" target="_blank" style="margin-left: 20px;">Instagram</a>
        </div>
    </footer>

    <div id="lightbox" class="lightbox-overlay">
        <img src="" alt="확대 이미지" class="lightbox-img">
    </div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const container = document.getElementById('project-detail-container');
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = parseInt(urlParams.get('id'));

        if (!projectId) {
            container.innerHTML = '<p style="text-align: center; padding: 100px 0;">Project ID not found.</p>';
            return;
        }

        try {
            const response = await fetch('../projects.json');
            if (!response.ok) throw new Error('Failed to load project data.');
            
            const projects = await response.json();
            const project = projects.find(p => p.id === projectId);
            const projectIndex = projects.findIndex(p => p.id === projectId);

            if (!project) {
                container.innerHTML = '<p style="text-align: center; padding: 100px 0;">Project not found.</p>';
                return;
            }

            // Update page title
            document.title = `${project.title} | 사비`;

            // Build content HTML
            let videosHTML = '';
            let imagesHTML = '';
            if (project.gallery && project.gallery.length > 0) {
                project.gallery.forEach(item => {
                    if (item.endsWith('.mp4')) {
                        videosHTML += `<div class="detail-image large reveal"><video autoplay muted loop playsinline controls><source src="../${item}" type="video/mp4"></video></div>`;
                    } else {
                        imagesHTML += `<img src="../${item}" alt="Gallery image for ${project.title}">`;
                    }
                });
            }

            let linksHTML = '';
            if (project.links && project.links.length > 0) {
                linksHTML = project.links.map(link => {
                    const isExternal = link.url.startsWith('http://') || link.url.startsWith('https://');
                    const href = isExternal ? link.url : `../${link.url}`;
                    return `<a class="detail-button" href="${href}" target="_blank" rel="noopener noreferrer">${link.text}</a>`;
                }).join(' ');
            }

            // Next project link
            let nextProjectHTML = '';
            const nextProject = projects[projectIndex + 1];
            if (nextProject) {
                nextProjectHTML = `
                    <div class="next-project reveal">
                        <span>Next Project</span>
                        <a href="?id=${nextProject.id}">${nextProject.title} →</a>
                    </div>`;
            } else {
                 nextProjectHTML = `
                    <div class="next-project reveal">
                        <span>Next Project</span>
                        <a href="../">마지막입니다. →</a>
                    </div>`;
            }


            const projectHTML = `
                <section class="project-header reveal delay-200">
                    <h1>${project.title}</h1>
                    <p class="project-subtitle">${project.subtitle} — ${project.year}</p>
                </section>

                <div class="detail-image large reveal delay-300">
                    <img src="../${project.mainImage}" alt="Main image for ${project.title}">
                </div>

                <section class="project-desc-block reveal">
                    <div class="desc-title">
                        <h3>Overview</h3>
                    </div>
                    <div class="desc-content">
                        <p>${project.overview}</p>
                        ${linksHTML}
                    </div>
                </section>

                ${videosHTML}

                <div class="detail-gallery reveal">
                    ${imagesHTML}
                </div>

                ${nextProjectHTML}
            `;

            container.innerHTML = projectHTML;
            
            // Re-initialize scripts after dynamic content is loaded
            initializePageScripts();

        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = `<p style="text-align: center; padding: 100px 0;">${error.message}</p>`;
        }
    });

    function initializePageScripts() {
        // 1. Lenis Smooth Scroll
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let lenis = null;
        if (!isMobile) {
            lenis = new Lenis({
                duration: 1.2,
                easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
                smoothWheel: true,
            });
            function raf(time) {
                lenis.raf(time);
                requestAnimationFrame(raf);
            }
            requestAnimationFrame(raf);
        }

        // 2. Reveal animations
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                }
            });
        }, { threshold: 0.1 });
        const targets = document.querySelectorAll('.reveal');
        targets.forEach(target => observer.observe(target));

        // 3. Lightbox for gallery images
        const galleryImages = document.querySelectorAll('.detail-gallery img');
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = lightbox.querySelector('.lightbox-img');
        const header = document.querySelector('header');

        const getScrollbarWidth = () => window.innerWidth - document.documentElement.clientWidth;

        galleryImages.forEach(img => {
            img.addEventListener('click', () => {
                const src = img.getAttribute('src');
                lightboxImg.setAttribute('src', src);
                
                const scrollbarWidth = getScrollbarWidth();
                document.body.style.paddingRight = `${scrollbarWidth}px`;
                if(header) header.style.paddingRight = `${scrollbarWidth}px`;

                document.body.style.overflow = 'hidden'; 
                if(lenis) lenis.stop();
                
                lightbox.classList.add('active');
            });
        });

        const closeLightbox = () => {
            lightbox.classList.remove('active');
            setTimeout(() => {
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                if(header) header.style.paddingRight = '';
                if(lenis) lenis.start();
            }, 300);
        };
        lightbox.addEventListener('click', closeLightbox);
    }
</script>
<script src="../darkmode.js"></script>
</body>
</html>
